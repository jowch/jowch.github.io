name: Build and Deploy
on: [push]
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./

    steps:
      - name: Checkout 🛎️
        uses: actions/checkout@v3
        # with:
        #   persist-credentials: false

      # - name: Cache  💾
      #   uses: actions/cache@v2
      #   with:
      #     path: ${{ github.workspace }}/.next/cache
      #     key: ${{ runner.os }}-nextjs-${{ hashFiles('**/package-lock.json') }}

      - name: Install and Build 🔧
        run: |
          npm ci
          npm run build

      - name: Verify Changed files
        uses: tj-actions/verify-changed-files@v10.1
        id: verify-changed-files
        with:
          files: |
              pubs.yml

      - name: Commit Updated Pubs
        if: steps.verify-changed-files.outputs.files_changed == 'true'
        run: |
          git config --global user.name 'Jonathan Chen'
          git config --global user.email 'jowch@users.noreply.github.com'
          git commit -am "Updated publications index"
          git push

      - name: Deploy 🚀
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: out # The folder the action should deploy.
